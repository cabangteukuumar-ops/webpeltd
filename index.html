<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peta Data Pelanggan PDAM - Simpan Permanen</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">

<style>
  body { margin:0; font-family: Arial, sans-serif; }
  #map { height: 94vh; width: 100%; }
  .controls {
    padding: 8px; background: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    position: relative; z-index: 1000;
  }
  select, input[type="file"], input[type="text"], button {
    padding: 6px 8px; border-radius: 4px; border: 1px solid #ccc;
  }
  button { background: #0078d7; color: white; cursor: pointer; }
  button:hover { background: #005a9e; }
</style>
</head>
<body>

<div class="controls">
  <input type="file" id="fileInput" accept=".xlsx, .xls">
  <button id="saveBtn">üíæ Simpan Data</button>
  <button id="clearBtn" style="background:#c0392b;">üóëÔ∏è Hapus Data</button>
  <select id="desaFilter"><option value="">Semua Desa</option></select>
  <select id="kelompokFilter"><option value="">Semua Kelompok</option></select>
  <input type="text" id="searchBox" placeholder="Cari nama / ID...">
</div>

<div id="map"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
let map = L.map('map').setView([5.55, 95.32], 13);
L.tileLayer.provider('Esri.WorldImagery').addTo(map);
L.control.scale().addTo(map);

let pelangganData = [];
let markersLayer = L.layerGroup().addTo(map);
let drawnItems = new L.FeatureGroup().addTo(map);

map.addControl(new L.Control.Draw({
  edit: { featureGroup: drawnItems },
  draw: { polygon:true, polyline:false, rectangle:false, circle:false, marker:false, circlemarker:false }
}));

const colorMap = {
  RT1:'red', RT2:'orange', RT3:'yellow',
  N1:'green', N3:'lime', SK1:'blue', SK2:'cyan',
  SU1:'purple', SU2:'violet', SU4:'pink',
  IP1:'brown', IP2:'gray', IP3:'black'
};

// === Load data dari localStorage saat halaman dibuka ===
window.addEventListener('load', () => {
  const saved = localStorage.getItem('pelangganData');
  if (saved) {
    pelangganData = JSON.parse(saved);
    tampilkanData(pelangganData);
    isiFilter(pelangganData);
    console.log("‚úÖ Data dimuat dari penyimpanan lokal");
  }

  const savedView = localStorage.getItem('mapView');
  if (savedView) {
    const v = JSON.parse(savedView);
    map.setView([v.lat, v.lng], v.zoom);
  }
});

// === Simpan posisi peta saat digeser/zoom ===
map.on('moveend', () => {
  const c = map.getCenter();
  localStorage.setItem('mapView', JSON.stringify({ lat:c.lat, lng:c.lng, zoom:map.getZoom() }));
});

// === Upload Excel ===
document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    const maxBulan = Math.max(...json.map(d => Number(d.bulan || 0)));
    pelangganData = json.filter(d => Number(d.bulan) === maxBulan);

    tampilkanData(pelangganData);
    isiFilter(pelangganData);
    simpanData();
  };
  reader.readAsArrayBuffer(file);
});

// === Simpan manual ke localStorage ===
document.getElementById('saveBtn').addEventListener('click', simpanData);
function simpanData() {
  localStorage.setItem('pelangganData', JSON.stringify(pelangganData));
  alert("‚úÖ Data pelanggan disimpan permanen di browser!");
}

// === Hapus data ===
document.getElementById('clearBtn').addEventListener('click', () => {
  if (confirm("Yakin ingin hapus semua data pelanggan dari penyimpanan?")) {
    localStorage.removeItem('pelangganData');
    markersLayer.clearLayers();
    pelangganData = [];
    alert("üóëÔ∏è Data dihapus. Silakan unggah ulang file Excel.");
  }
});

// === Tampilkan marker pelanggan ===
function tampilkanData(data) {
  markersLayer.clearLayers();

  data.forEach(row => {
    if (!row.latitude || !row.longitude) return;
    const warna = colorMap[row.kelompok] || 'blue';

    const marker = L.circleMarker([row.latitude, row.longitude], {
      radius: 6, color:'#333', weight:1,
      fillColor: warna, fillOpacity: 0.9
    });

    const popup = `
      <b>ID Pelanggan:</b> ${row.idpel || '-'}<br>
      <b>Nama:</b> ${row.nama || '-'}<br>
      <b>Kelompok:</b> ${row.kelompok || '-'}<br>
      <b>Keterangan Kelompok:</b> ${row['keterangan kelompok'] || '-'}<br>
      <b>Pemakaian:</b> ${row.mpakai || 0} m¬≥<br>
      <b>Total:</b> Rp ${Number(row.total || 0).toLocaleString()}<br>
      <b>Desa:</b> ${row.desa || '-'}<br>
      <b>Kecamatan:</b> ${row.kecamatan || '-'}
    `;

    marker.bindPopup(popup);
    markersLayer.addLayer(marker);
  });
}

// === Filter Desa & Kelompok ===
function isiFilter(data) {
  const desaSet = new Set(data.map(d => d.desa).filter(Boolean));
  const kelompokSet = new Set(data.map(d => d.kelompok).filter(Boolean));

  const desaSel = document.getElementById('desaFilter');
  const kelSel = document.getElementById('kelompokFilter');
  desaSel.innerHTML = '<option value="">Semua Desa</option>';
  kelSel.innerHTML = '<option value="">Semua Kelompok</option>';
  desaSet.forEach(v => desaSel.innerHTML += `<option>${v}</option>`);
  kelompokSet.forEach(v => kelSel.innerHTML += `<option>${v}</option>`);
}

function filterData() {
  const d = document.getElementById('desaFilter').value;
  const k = document.getElementById('kelompokFilter').value;
  const s = document.getElementById('searchBox').value.toLowerCase();

  const hasil = pelangganData.filter(r =>
    (!d || r.desa === d) &&
    (!k || r.kelompok === k) &&
    (!s || (r.nama && r.nama.toLowerCase().includes(s)) || (r.idpel && r.idpel.toString().includes(s)))
  );

  tampilkanData(hasil);
}

document.getElementById('desaFilter').addEventListener('change', filterData);
document.getElementById('kelompokFilter').addEventListener('change', filterData);
document.getElementById('searchBox').addEventListener('input', filterData);

// === Saat gambar polygon, hitung jumlah & total pemakaian ===
map.on(L.Draw.Event.CREATED, e => {
  const layer = e.layer;
  drawnItems.addLayer(layer);

  const polygon = layer.toGeoJSON();
  const dalam = pelangganData.filter(r => {
    if (!r.latitude || !r.longitude) return false;
    const point = turf.point([parseFloat(r.longitude), parseFloat(r.latitude)]);
    return turf.booleanPointInPolygon(point, polygon);
  });

  const jumlah = dalam.length;
  const totalPemakaian = dalam.reduce((sum, d) => sum + Number(d.mpakai || 0), 0);
  const totalRupiah = dalam.reduce((sum, d) => sum + Number(d.total || 0), 0);
  const ids = dalam.map(d => d.idpel).join(', ');

  layer.bindPopup(`
    <b>Jumlah Pelanggan:</b> ${jumlah}<br>
    <b>Total Pemakaian:</b> ${totalPemakaian.toLocaleString()} m¬≥<br>
    <b>Total Tagihan:</b> Rp ${totalRupiah.toLocaleString()}<br>
    <b>ID Pelanggan:</b> ${ids}
  `).openPopup();
});
</script>
</body>
</html>
